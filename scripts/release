#!/bin/bash
# Release script for rustloc
#
# Usage:
#   ./scripts/release patch    # Bump patch version (0.1.0 -> 0.1.1)
#   ./scripts/release minor    # Bump minor version (0.1.0 -> 0.2.0)
#   ./scripts/release major    # Bump major version (0.1.0 -> 1.0.0)
#   ./scripts/release 1.2.3    # Set specific version

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the script directory and project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_ROOT"

# Check for uncommitted changes
if ! git diff --quiet || ! git diff --staged --quiet; then
    echo -e "${RED}Error: You have uncommitted changes. Please commit or stash them first.${NC}"
    exit 1
fi

# Check we're on main branch
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "main" ]; then
    echo -e "${YELLOW}Warning: You're not on the main branch (currently on $CURRENT_BRANCH).${NC}"
    read -p "Continue anyway? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Get current version from workspace Cargo.toml
CURRENT_VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')

if [ -z "$CURRENT_VERSION" ]; then
    echo -e "${RED}Error: Could not determine current version from Cargo.toml${NC}"
    exit 1
fi

echo -e "${GREEN}Current version: $CURRENT_VERSION${NC}"

# Parse the argument
ARG="${1:-}"

if [ -z "$ARG" ]; then
    echo "Usage: $0 <patch|minor|major|VERSION>"
    echo ""
    echo "Examples:"
    echo "  $0 patch     # $CURRENT_VERSION -> next patch"
    echo "  $0 minor     # $CURRENT_VERSION -> next minor"
    echo "  $0 major     # $CURRENT_VERSION -> next major"
    echo "  $0 1.2.3     # Set to specific version"
    exit 1
fi

# Calculate new version
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

case "$ARG" in
    patch)
        NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
        ;;
    minor)
        NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
        ;;
    major)
        NEW_VERSION="$((MAJOR + 1)).0.0"
        ;;
    *)
        # Assume it's a version number
        if [[ ! "$ARG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo -e "${RED}Error: Invalid version format '$ARG'. Expected X.Y.Z${NC}"
            exit 1
        fi
        NEW_VERSION="$ARG"
        ;;
esac

echo -e "${GREEN}New version: $NEW_VERSION${NC}"
echo ""

# Confirm
read -p "Proceed with release v$NEW_VERSION? [y/N] " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 1
fi

echo ""
echo -e "${YELLOW}Updating versions...${NC}"

# Update workspace version in root Cargo.toml
sed -i.bak "s/^version = \"$CURRENT_VERSION\"/version = \"$NEW_VERSION\"/" Cargo.toml
rm -f Cargo.toml.bak

# Update rustloclib dependency version in rustloc/Cargo.toml if it has a specific version
# (currently it uses workspace, so this may not be needed, but let's be safe)

# Verify the changes
echo ""
echo -e "${YELLOW}Verifying changes...${NC}"
cargo check --all

echo ""
echo -e "${YELLOW}Running tests...${NC}"
cargo test --all

echo ""
echo -e "${YELLOW}Committing version bump...${NC}"
git add Cargo.toml Cargo.lock
git commit -m "chore: Release v$NEW_VERSION"

echo ""
echo -e "${YELLOW}Creating git tag v$NEW_VERSION...${NC}"
git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"

echo ""
echo -e "${YELLOW}Pushing to origin...${NC}"
git push origin main
git push origin "v$NEW_VERSION"

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Release v$NEW_VERSION initiated!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo "The release workflow will now:"
echo "  1. Build binaries for all platforms"
echo "  2. Create a GitHub release with the binaries"
echo "  3. Publish rustloclib to crates.io"
echo "  4. Publish rustloc to crates.io"
echo ""
echo "Monitor progress at:"
echo "  https://github.com/arthur-debert/rustloc/actions"
echo ""
